---
phase: 01-testing-foundation
plan: 01
type: execute
---

<objective>
Comprehensive unit tests for ExternalDNSSyncer reconciliation logic.

Purpose: Test the core sync algorithm that determines what DNS records to add/update/delete, ensuring correctness of the reconciliation logic that is central to the project's core value: "DNS records always match Traefik routes."

Output: `tests/test_syncer.py` with comprehensive unit tests for sync logic using mocked providers.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md

**Codebase constraints:**
- pytest 8.3+ with inline test data (no separate fixtures directory)
- Test naming: `test_{function}_{scenario}`
- Type hints on all test functions: `-> None`
- Use `tmp_path` fixture for filesystem tests
- Mocking: pytest built-in, no extensive mocking library

**Key source files:**
@src/external_dns/cli.py (lines 778-1053: ExternalDNSSyncer class)
@tests/test_utils.py (existing test patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mock providers and test fixtures for syncer tests</name>
  <files>tests/test_syncer.py</files>
  <action>
Create `tests/test_syncer.py` with:

1. Mock DNS provider class that tracks calls:
   - `MockDNSProvider(DNSProvider)` with in-memory record storage
   - Track add/delete/update calls for verification
   - `get_records()` returns current in-memory state
   - `add_record()`, `delete_record()`, `update_record()` modify in-memory state

2. Mock reverse proxy provider class:
   - `MockProxyProvider(ReverseProxyProvider)`
   - Configurable instances and routes via constructor
   - `get_instances()` returns configured instances
   - `get_routes(instance)` returns configured routes

3. Helper function to create test syncer:
   - `create_test_syncer(dns_records, proxy_instances, proxy_routes, static_rewrites, exclude_patterns)`
   - Returns configured `ExternalDNSSyncer` with mocked providers and tmp_path StateStore

Use pytest `tmp_path` fixture for StateStore path. Follow existing test patterns from test_utils.py (flat functions, descriptive names, type hints).
  </action>
  <verify>pytest tests/test_syncer.py -v --collect-only shows test collection works (may show 0 tests, that's OK)</verify>
  <done>Mock providers and fixtures exist in test_syncer.py, file imports successfully</done>
</task>

<task type="auto">
  <name>Task 2: Add sync reconciliation unit tests</name>
  <files>tests/test_syncer.py</files>
  <action>
Add comprehensive unit tests for `ExternalDNSSyncer.sync_once()`:

**Basic CRUD operations:**
- `test_sync_adds_new_record_when_route_discovered`: New route → DNS record created
- `test_sync_removes_record_when_route_removed`: Route disappears → DNS record deleted
- `test_sync_updates_record_when_target_ip_changes`: Same domain, new IP → record updated

**Multi-instance scenarios:**
- `test_sync_uses_first_instance_ip_for_conflicting_domains`: Domain on multiple instances with different IPs → uses first instance's IP
- `test_sync_preserves_record_when_one_instance_fails`: Instance unreachable → records from that instance preserved (not deleted)
- `test_sync_removes_orphaned_records_when_instance_removed`: Instance removed from config → its DNS records cleaned up

**Domain filtering:**
- `test_sync_excludes_domains_matching_exact_pattern`: Exact exclusion pattern → domain not synced
- `test_sync_excludes_domains_matching_wildcard_pattern`: Wildcard exclusion → matching domains not synced
- `test_sync_excludes_domains_matching_regex_pattern`: Regex exclusion → matching domains not synced
- `test_sync_removes_existing_excluded_domain_records`: Newly excluded domain → existing DNS record deleted

**Zone handling:**
- `test_sync_skips_external_zone_domains`: External zone routes → not added to DNS
- `test_sync_only_syncs_internal_zone_domains`: Mix of zones → only internal zones synced

**Static rewrites:**
- `test_sync_adds_missing_static_rewrite`: Static rewrite not in DNS → added
- `test_sync_updates_static_rewrite_with_wrong_ip`: Static rewrite exists with different IP → updated
- `test_sync_preserves_static_rewrite_on_route_removal`: Static rewrite domain removed from routes → NOT deleted from DNS

**Edge cases:**
- `test_sync_handles_empty_routes`: No routes discovered → no records added
- `test_sync_handles_duplicate_dns_records`: Multiple DNS records for same domain → consolidated to one
- `test_sync_idempotent_on_repeated_calls`: Same state synced twice → no changes second time

Each test should:
1. Set up initial DNS state and proxy routes via mock constructors
2. Call `syncer.sync_once()`
3. Assert expected DNS records exist/don't exist via mock provider
4. Assert mock provider received expected add/delete/update calls where relevant
  </action>
  <verify>pytest tests/test_syncer.py -v passes all tests</verify>
  <done>All sync reconciliation tests pass, covering add/update/delete/filter/zone/static-rewrite scenarios</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `make lint` passes (ruff check)
- [ ] `make test` passes all tests including new ones
- [ ] New tests actually test the behavior (not just "tests exist")
- [ ] Tests cover the scenarios listed in Task 2
</verification>

<success_criteria>
- tests/test_syncer.py exists with mock providers and fixtures
- At least 15 unit tests for sync reconciliation logic
- All tests pass
- No ruff linting errors
- Tests use existing project conventions (flat functions, type hints, descriptive names)
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-foundation/01-01-SUMMARY.md`
</output>
