---
phase: 01-testing-foundation
plan: 02
type: execute
---

<objective>
Unit tests for provider implementations and state management.

Purpose: Test AdGuard Home provider, Traefik provider, and StateStore in isolation with mocked HTTP responses. These components handle external communication and must be robust.

Output: `tests/test_adguard_provider.py`, `tests/test_traefik_provider.py`, `tests/test_state_store.py`
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md
@.planning/codebase/CONVENTIONS.md

**Prior plan summary (if exists):**
@.planning/phases/01-testing-foundation/01-01-SUMMARY.md

**Codebase constraints:**
- pytest 8.3+ with `responses` or `unittest.mock` for HTTP mocking
- Test naming: `test_{function}_{scenario}`
- Type hints on all test functions: `-> None`
- Use `tmp_path` fixture for filesystem tests

**Key source files:**
@src/external_dns/cli.py (lines 303-358: AdGuardDNSProvider, lines 386-634: TraefikProxyProvider, lines 753-771: StateStore)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AdGuard Home provider unit tests</name>
  <files>tests/test_adguard_provider.py</files>
  <action>
Create `tests/test_adguard_provider.py` with HTTP mocking using `unittest.mock.patch` on `requests.Session`:

**Connection tests:**
- `test_test_connection_success`: Mock 200 response → returns True
- `test_test_connection_failure`: Mock connection error → returns False, logs error

**CRUD operations:**
- `test_get_records_returns_dns_records`: Mock JSON response → returns list of DNSRecord
- `test_get_records_returns_empty_on_error`: Mock error → returns empty list
- `test_add_record_success`: Mock 200 → returns True, logs success
- `test_add_record_failure`: Mock error → returns False, logs error
- `test_delete_record_success`: Mock 200 → returns True, logs success
- `test_delete_record_failure`: Mock error → returns False, logs error
- `test_update_record_calls_delete_then_add`: Verify update delegates to delete+add

**Authentication:**
- `test_provider_uses_basic_auth_when_credentials_provided`: Verify HTTPBasicAuth set
- `test_provider_works_without_auth`: No credentials → no auth header

Use `@patch.object` or `@patch` decorator for session mocking. Assert correct URLs, payloads, and return values.
  </action>
  <verify>pytest tests/test_adguard_provider.py -v passes all tests</verify>
  <done>AdGuard provider tests pass, covering connection/CRUD/auth scenarios</done>
</task>

<task type="auto">
  <name>Task 2: Add Traefik provider unit tests</name>
  <files>tests/test_traefik_provider.py</files>
  <action>
Create `tests/test_traefik_provider.py`:

**Instance loading:**
- `test_get_instances_from_yaml_config`: YAML file with instances → returns ProxyInstance list
- `test_get_instances_from_json_env`: JSON string → returns ProxyInstance list
- `test_get_instances_single_fallback`: URL+IP env vars → returns single instance
- `test_get_instances_empty_when_no_config`: No config → returns empty list
- `test_get_instances_skips_invalid_entries`: Missing required fields → skipped

**Route discovery (mock HTTP):**
- `test_get_routes_extracts_hostnames_from_host_rule`: Router with `Host(\`example.com\`)` → returns route
- `test_get_routes_handles_multiple_routers`: Multiple routers → multiple routes
- `test_get_routes_returns_empty_on_connection_error`: Mock error → raises exception (let caller handle)

**Router filtering:**
- `test_router_filter_matches_wildcard_pattern`: Filter `*-internal` → only matching routers returned
- `test_router_filter_empty_matches_all`: Empty filter → all routers returned
- `test_middleware_filter_excludes_routers_without_middleware`: Middleware filter → routers without it excluded

**Zone detection:**
- `test_detect_zone_from_router_name_suffix_internal`: `myapp-internal@docker` → INTERNAL zone
- `test_detect_zone_from_router_name_suffix_external`: `myapp-external@docker` → EXTERNAL zone
- `test_detect_zone_defaults_when_no_suffix`: No suffix → uses default zone

Use `tmp_path` fixture for YAML config tests. Mock HTTP responses for get_routes tests.
  </action>
  <verify>pytest tests/test_traefik_provider.py -v passes all tests</verify>
  <done>Traefik provider tests pass, covering instance loading/route discovery/filtering/zones</done>
</task>

<task type="auto">
  <name>Task 3: Add StateStore unit tests</name>
  <files>tests/test_state_store.py</files>
  <action>
Create `tests/test_state_store.py`:

**Load operations:**
- `test_load_returns_default_state_when_file_missing`: No file → returns default structure
- `test_load_returns_file_contents`: Valid JSON file → returns parsed content
- `test_load_returns_default_on_invalid_json`: Corrupted file → returns default, logs warning

**Save operations:**
- `test_save_creates_parent_directories`: Nested path → creates dirs
- `test_save_writes_valid_json`: Save state → file contains valid JSON
- `test_save_atomic_via_temp_file`: Save uses temp file + rename (atomic write pattern)

**State structure:**
- `test_default_state_has_required_keys`: Default state has version, instances, domains keys

Use `tmp_path` fixture for all tests. Verify file contents with `Path.read_text()`.
  </action>
  <verify>pytest tests/test_state_store.py -v passes all tests</verify>
  <done>StateStore tests pass, covering load/save/atomic write scenarios</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `make lint` passes (ruff check)
- [ ] `make test` passes all tests including new ones
- [ ] Each provider has comprehensive test coverage
- [ ] Tests use mocking appropriately (no real HTTP calls)
</verification>

<success_criteria>
- tests/test_adguard_provider.py exists with ~10 tests
- tests/test_traefik_provider.py exists with ~15 tests
- tests/test_state_store.py exists with ~7 tests
- All tests pass
- No ruff linting errors
- HTTP calls properly mocked (no external dependencies)
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-foundation/01-02-SUMMARY.md`
</output>
